<!-- CONTENEDOR PRINCIPAL -->
<!-- Usamos h-[100dvh] para llenar la pantalla exacta y bg-slate-950 para contraste elegante -->
<div class="h-[100dvh] w-full bg-slate-950 flex items-center justify-center p-2 md:p-4 overflow-hidden">
  
  <!-- CARD PRINCIPAL -->
  <!-- 'max-h-[95dvh]' asegura que nunca sea más alto que la pantalla -->
  <!-- 'h-full' intenta llenar ese espacio si es necesario -->
  <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-5xl max-h-[95dvh] h-auto flex flex-col relative border-t-4 border-emerald-500">
    
    <!-- HEADER -->
    <!-- 'shrink-0' evita que el header se aplaste si falta espacio -->
    <div class="bg-slate-50 p-3 landscape:py-2 border-b border-gray-200 flex justify-between items-center shrink-0">
      <h1 class="text-lg md:text-xl font-bold text-slate-700 tracking-wide flex items-center gap-2">
        <div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div>
        SANTI POS
      </h1>
      <div class="text-xs md:text-sm font-mono font-bold text-emerald-600 bg-emerald-100 px-2 py-1 rounded">
         {{ currentDate | date:'HH:mm' }}
      </div>
    </div>

    <!-- ERRORES -->
    @if (errorMessage()) {
      <div class="bg-red-500 text-white text-center py-1 text-sm font-bold animate-pulse absolute top-12 left-0 w-full z-50 shadow-md">
        {{ errorMessage() }}
      </div>
    }

    <!-- AREA DE CONTENIDO (Scrollable internamente) -->
    <div class="flex-1 overflow-hidden relative flex flex-col">

        <!-- PASO 1: SELECCIÓN DE USUARIO -->
        @if (currentStep() === 'SELECT_USER') {
          <div class="flex-1 overflow-y-auto p-4 md:p-8 animate-fade-in custom-scrollbar">
            <h2 class="text-lg md:text-xl font-light text-slate-600 mb-4 text-center uppercase tracking-widest sticky top-0 bg-white/95 backdrop-blur z-10 py-2">
              ¿Quién eres?
            </h2>

            <!-- Grid auto-ajustable -->
            <div class="grid grid-cols-2 md:grid-cols-3 landscape:grid-cols-4 gap-3 md:gap-4 max-w-4xl mx-auto pb-4">
              @for (user of users; track user.id; let i = $index) {
                <button 
                  (click)="selectUser(user)"
                  class="group relative bg-white border-2 border-slate-100 hover:border-emerald-400 hover:shadow-lg hover:shadow-emerald-100/50 rounded-xl p-3 transition-all duration-200 active:scale-95 flex flex-col items-center justify-center min-h-[110px]"
                >
                  <!-- Badge # -->
                  <div class="absolute top-2 left-2 w-6 h-6 bg-slate-200 text-slate-600 rounded flex items-center justify-center font-bold font-mono text-xs group-hover:bg-emerald-500 group-hover:text-white transition-colors">
                    {{ i + 1 }}
                  </div>

                  <!-- Avatar -->
                  <div class="w-14 h-14 rounded-full bg-slate-50 mb-2 flex items-center justify-center text-xl text-slate-400 font-bold group-hover:bg-emerald-50 group-hover:text-emerald-600 transition-colors border-2 border-transparent group-hover:border-emerald-200">
                    {{ user.name.charAt(0) }}
                  </div>

                  <!-- Info -->
                  <div class="text-center w-full truncate px-1">
                    <div class="font-bold text-sm text-slate-700 group-hover:text-emerald-700 truncate">{{ user.name }}</div>
                    <div class="text-[10px] text-slate-400 uppercase font-semibold">{{ user.role }}</div>
                  </div>
                </button>
              }
            </div>
          </div>
        }

        <!-- PASO 2: INGRESO DE PIN -->
        @if (currentStep() === 'ENTER_PIN' && selectedUser()) {
          <div class="flex-1 flex flex-col landscape:flex-row h-full animate-fade-in bg-slate-50">
            
            <!-- Botón Volver -->
            <button (click)="resetToUserSelection()" class="absolute top-4 left-4 z-20 text-slate-400 hover:text-emerald-600 transition-colors p-2 bg-white rounded-full shadow-sm border border-slate-200">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                </svg>
            </button>

            <!-- IZQUIERDA: Usuario & Feedback -->
            <div class="flex-1 flex flex-col items-center justify-center p-4 landscape:border-r border-slate-200 bg-white landscape:w-1/2">
                <div class="relative mb-4">
                    <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-3xl font-bold shadow-inner border-4 border-white ring-2 ring-emerald-500">
                        {{ selectedUser()?.name?.charAt(0) }}
                    </div>
                </div>
                
                <h2 class="text-xl font-bold text-slate-800">{{ selectedUser()?.name }}</h2>
                <p class="text-slate-400 text-xs uppercase font-bold tracking-widest mb-6">Ingrese PIN</p>

                <!-- Dots Visuales -->
                <div class="flex gap-4 h-4 mb-2">
                   @for (dot of [0,1,2,3]; track dot) {
                     <div class="w-4 h-4 rounded-full border-2 transition-all duration-300"
                          [class.bg-emerald-500]="pin().length > dot"
                          [class.border-emerald-500]="pin().length > dot"
                          [class.border-slate-300]="pin().length <= dot"
                          [class.scale-110]="pin().length > dot">
                     </div>
                   }
                </div>
            </div>

            <!-- DERECHA: Teclado -->
            <div class="flex-1 flex items-center justify-center p-2 bg-slate-50 landscape:w-1/2">
                <div class="grid grid-cols-3 gap-2 w-full max-w-[260px] h-full max-h-[300px]">
                  @for (num of [1,2,3,4,5,6,7,8,9]; track num) {
                    <button (click)="appendPin(num)" 
                            class="bg-white border-b-2 border-slate-200 rounded-lg text-xl font-bold text-slate-600 hover:bg-emerald-50 hover:text-emerald-700 hover:border-emerald-200 active:border-b-0 active:translate-y-0.5 transition-all shadow-sm">
                      {{ num }}
                    </button>
                  }
                  
                  <!-- Botón Borrar -->
                  <button (click)="pin.set('')" class="bg-red-50 border-b-2 border-red-100 rounded-lg text-red-500 font-bold hover:bg-red-100 active:border-b-0 active:translate-y-0.5 transition-all flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75 14.25 12m0 0 2.25 2.25M14.25 12l2.25-2.25M14.25 12l-2.25 2.25m-2.25-2.25-2.25 2.25m0 0-2.25-2.25m2.25 2.25L9.75 9.75M9.75 12l-2.25 2.25M9.75 12l2.25-2.25M9.75 12l-2.25 2.25m-2.25-2.25-2.25 2.25" />
                    </svg>
                  </button>
                  
                  <button (click)="appendPin(0)" class="bg-white border-b-2 border-slate-200 rounded-lg text-xl font-bold text-slate-600 hover:bg-emerald-50 hover:text-emerald-700 active:border-b-0 active:translate-y-0.5 transition-all shadow-sm">0</button>
                  
                  <!-- Botón OK -->
                  <button (click)="submitLogin()" class="bg-emerald-500 border-b-2 border-emerald-700 rounded-lg text-white font-bold hover:bg-emerald-400 active:border-b-0 active:translate-y-0.5 transition-all shadow-md shadow-emerald-200">
                    OK
                  </button>
                </div>
            </div>

          </div>
        }

    </div>
  </div>
</div>
